{% extends 'app/base.html' %}
{% load tz %}

{% block title %}{{ video.title }} - VideoQ{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- 動画プレイヤー -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4>{{ video.title }}</h4>
                    <small class="text-muted">
                        アップロード: {{ video.uploaded_at|localtime|date:"Y-m-d H:i" }} | 
                        ステータス: 
                        {% if video.status == 'pending' %}
                            <span class="badge bg-secondary">処理待ち</span>
                        {% elif video.status == 'processing' %}
                            <span class="badge bg-info">処理中</span>
                        {% elif video.status == 'completed' %}
                            <span class="badge bg-success">完了</span>
                        {% elif video.status == 'error' %}
                            <span class="badge bg-danger">{{ video.error_message }}</span>
                        {% endif %}
                    </small>
                </div>
                <div class="card-body">
                    {% if video.status == 'completed' %}
                        <video id="videoPlayer" controls class="w-100" style="max-height: 400px;">
                            <source src="{{ video.file.url }}" type="video/mp4">
                            お使いのブラウザは動画再生に対応していません。
                        </video>
                        
                        <!-- コントロール -->
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="jumpTime" class="form-label">時間ジャンプ</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="jumpTime" placeholder="秒" step="0.1" min="0">
                                        <button class="btn btn-outline-primary" type="button" onclick="jumpToTime()">ジャンプ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            {% if video.status == 'pending' %}
                                <i class="bi bi-clock display-1 text-muted"></i>
                                <h5 class="mt-3">処理待ち</h5>
                                <p class="text-muted">動画の処理が開始されるまでお待ちください。</p>
                            {% elif video.status == 'processing' %}
                                <i class="bi bi-gear display-1 text-muted"></i>
                                <h5 class="mt-3">処理中</h5>
                                <p class="text-muted">動画の文字起こしと埋め込み処理中です。</p>
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            {% elif video.status == 'error' %}
                                <i class="bi bi-exclamation-triangle display-1 text-danger"></i>
                                <h5 class="mt-3">エラーが発生しました</h5>
                                <p class="text-danger">{{ video.error_message }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 動画情報 -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6><i class="bi bi-info-circle"></i> 動画情報</h6>
                </div>
                <div class="card-body">
                    {% if video.tags.all %}
                        <div class="mb-3">
                            <strong>タグ:</strong>
                            <div class="mt-1">
                                {% for tag in video.tags.all %}
                                    <span class="badge bg-secondary me-1">{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    {% if video.description %}
                        <p><strong>説明:</strong> {{ video.description }}</p>
                    {% endif %}
                    
                    {% if video.status == 'completed' %}
                        <!-- セグメント数・チャンク数の表示を削除 -->
                    {% endif %}
                    
                    <div class="d-flex gap-2 mt-3">
                        <a href="{% url 'app:video_edit' video.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-pencil"></i> 編集
                        </a>
                        <a href="{% url 'app:delete_video' video.pk %}" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash"></i> 削除
                        </a>
                    </div>
                    
                    {% if video.status == 'completed' and video.transcript %}
                        <hr>
                        <h6>
                            <i class="bi bi-file-text"></i> 文字起こしテキスト
                            <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#transcriptCollapse" aria-expanded="false" aria-controls="transcriptCollapse">
                                <i class="bi bi-chevron-down"></i> 展開
                            </button>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="downloadTranscript()">
                                <i class="bi bi-download"></i> ダウンロード
                            </button>
                        </h6>
                        <div class="collapse" id="transcriptCollapse">
                            <div class="transcript-text p-3 bg-light rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
                                {{ video.transcript|linebreaks }}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if video.status == 'completed' %}
<script>
// 動画プレイヤー
const video = document.getElementById('videoPlayer');

// URLパラメータから時間を取得して自動ジャンプ
{% if jump_time %}
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        seekToTime({{ jump_time }});
    }, 1000); // 1秒後に実行（動画の読み込みを待つ）
});
{% endif %}

// URLハッシュフラグメントから時間を取得して自動ジャンプ
document.addEventListener('DOMContentLoaded', function() {
    // URLハッシュフラグメントをチェック
    const hash = window.location.hash;
    if (hash && hash.startsWith('#time=')) {
        const time = parseFloat(hash.substring(6)); // '#time=' の後ろの部分を取得
        if (!isNaN(time) && time >= 0) {
            setTimeout(function() {
                seekToTime(time);
            }, 1000); // 1秒後に実行（動画の読み込みを待つ）
        }
    }
});

// 時間ジャンプ機能
function jumpToTime() {
    const timeInput = document.getElementById('jumpTime');
    const time = parseFloat(timeInput.value);
    
    if (!isNaN(time) && time >= 0) {
        video.currentTime = time;
        timeInput.value = '';
    }
}

// 外部からの時間ジャンプ（検索結果から呼び出し）
function seekToTime(time) {
    if (!isNaN(time) && time >= 0) {
        video.currentTime = time;
        video.play();
    }
}

// キーボードショートカット
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT') return; // 入力フィールドでは無効
    
    switch(e.code) {
        case 'Space':
            e.preventDefault();
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
            break;
        case 'ArrowLeft':
            e.preventDefault();
            video.currentTime -= 5;
            break;
        case 'ArrowRight':
            e.preventDefault();
            video.currentTime += 5;
            break;
    }
});

// 文字起こしテキストをダウンロード
function downloadTranscript() {
    const transcriptText = `{{ video.transcript|escapejs }}`;
    const videoTitle = `{{ video.title|escapejs }}`;
    const blob = new Blob([transcriptText], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${videoTitle}_transcript.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// 展開/折りたたみボタンのアイコンを更新
document.addEventListener('DOMContentLoaded', function() {
    const transcriptCollapse = document.getElementById('transcriptCollapse');
    const toggleButton = document.querySelector('[data-bs-target="#transcriptCollapse"]');
    
    if (transcriptCollapse && toggleButton) {
        transcriptCollapse.addEventListener('show.bs.collapse', function() {
            const icon = toggleButton.querySelector('i');
            icon.className = 'bi bi-chevron-up';
            toggleButton.innerHTML = '<i class="bi bi-chevron-up"></i> 折りたたみ';
        });
        
        transcriptCollapse.addEventListener('hide.bs.collapse', function() {
            const icon = toggleButton.querySelector('i');
            icon.className = 'bi bi-chevron-down';
            toggleButton.innerHTML = '<i class="bi bi-chevron-down"></i> 展開';
        });
    }
});
</script>
{% endif %}
{% endblock %} 