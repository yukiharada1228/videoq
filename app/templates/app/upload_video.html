{% extends 'app/base.html' %}
{% load tz %}

{% block title %}動画アップロード - VideoQ{% endblock %}

{% block content %}


<div class="upload-container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- ヘッダー -->
            <div class="upload-header text-center mb-5">
                <div class="upload-icon mb-3">
                    <i class="bi bi-cloud-upload"></i>
                </div>
                <h1 class="page-title mb-3">動画をアップロード</h1>
                <p class="lead text-muted">AI搭載の動画分析で、あなたの動画コンテンツを最大限活用</p>
            </div>

            <!-- アップロードフォーム -->
            <div class="card upload-card">
                {% if user_video_remaining|default:0 <= 0 %}
                <div class="alert alert-warning m-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    動画の上限（{{ user_video_limit }}本）に達しています。不要な動画を削除してください。
                    <a href="{% url 'app:video_list' %}" class="alert-link ms-2">動画一覧へ</a>
                </div>
                {% endif %}
                <div class="upload-area" id="upload-area" {% if user_video_remaining|default:0 <= 0 %}style="pointer-events: none; opacity: .6;"{% endif %}>
                    <div class="upload-content text-center">
                        <div class="upload-icon-large mb-4">
                            <i class="bi bi-cloud-upload"></i>
                        </div>
                        <h4 class="mb-3">動画ファイルをドラッグ&ドロップ</h4>
                        <p class="text-muted mb-4">または、下のボタンからファイルを選択してください</p>
                        {% if user_video_remaining|default:0 <= 0 %}
                        <button type="button" class="btn btn-primary btn-lg" disabled title="動画上限に達しています">
                            <i class="bi bi-folder2-open me-2"></i>ファイルを選択
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('id_file').click()">
                            <i class="bi bi-folder2-open me-2"></i>ファイルを選択
                        </button>
                        {% endif %}
                        <div class="upload-info mt-4">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>アップロード制限</strong><br>
                                対応形式: MP4, AVI, MOV, MKV<br>
                                <span class="text-primary fw-bold">※最大アップロードサイズは {{ video_upload_max_size_mb }}MB です</span>
                                <div class="mt-2 small text-muted">
                                    現在の動画数: <strong>{{ user_video_count }}</strong> / 上限: <strong>{{ user_video_limit }}</strong>（残り <strong>{{ user_video_remaining }}</strong> 本）
                                </div>
                            </div>
                            <div class="alert alert-warning" id="file-size-warning" style="display: none;">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>ファイルサイズが上限を超えています</strong><br>
                                選択されたファイルは{{ video_upload_max_size_mb }}MBを超えています。より小さなファイルを選択してください。
                            </div>
                        </div>
                    </div>
                </div>

                <form method="post" enctype="multipart/form-data" id="upload-form" class="upload-form">
                    {% csrf_token %}
                    
                    <div class="form-group mb-4">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            <i class="bi bi-tag me-2"></i>動画タイトル
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.title.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group mb-4">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            <i class="bi bi-text-paragraph me-2"></i>説明（任意）
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- 既存タグの選択 -->
                    <div class="form-group mb-4">
                        <label class="form-label">
                            <i class="bi bi-hash me-2"></i>既存のタグから選択
                        </label>
                        <div class="tag-selection-container">
                            {% if existing_tags %}
                                <div class="existing-tags-grid">
                                    {% for tag in existing_tags %}
                                        <div class="tag-checkbox-item">
                                            <input type="checkbox" name="existing_tags" value="{{ tag.id }}" id="tag_{{ tag.id }}" class="tag-checkbox">
                                            <label for="tag_{{ tag.id }}" class="tag-label">
                                                <span class="tag-name">{{ tag.name }}</span>
                                                {% if tag.color %}
                                                    <span class="tag-color" style="background-color: {{ tag.color }};"></span>
                                                {% endif %}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-muted">
                                    <i class="bi bi-info-circle me-2"></i>まだタグが作成されていません。下の入力欄で新規タグを作成できます。
                                </div>
                            {% endif %}
                        </div>

                    </div>

                    <!-- 新規タグの入力 -->
                    <div class="form-group mb-4">
                        <label for="{{ form.new_tags_input.id_for_label }}" class="form-label">
                            <i class="bi bi-plus-circle me-2"></i>新規タグの追加
                        </label>
                        {{ form.new_tags_input }}
                        {% if form.new_tags_input.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.new_tags_input.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">新しいタグはカンマ , で区切って入力。既存のタグと組み合わせて使用できます。</div>
                    </div>

                    <div class="form-group mb-4" style="display: none;">
                        {{ form.file }}
                        {% if form.file.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.file.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- API設定チェック警告 -->
                    {% if not api_key_configured %}
                    <div class="alert alert-warning mb-4" id="api-key-warning">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle me-3 mt-1"></i>
                            <div>
                                <h6 class="alert-heading mb-2">API設定がまだです</h6>
                                <p class="mb-2">動画のAI分析機能を利用するには、OpenAI APIキーの設定が必要です。</p>
                                <a href="{% url 'app:openai_key_update' %}" class="btn btn-warning btn-sm">
                                    <i class="bi bi-key me-2"></i>API設定を行う
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="upload-btn" {% if user_video_remaining|default:0 <= 0 %}disabled title="動画上限に達しています"{% else %}disabled {% if not api_key_configured %}title="API設定を完了してください"{% endif %}{% endif %}>
                            <i class="bi bi-upload me-2"></i>動画をアップロード
                        </button>
                    </div>
                </form>
            </div>

            <!-- 処理状況表示エリア -->
            <div class="card processing-card" id="processing-status" style="display: none;">
                <div class="processing-header text-center mb-4">
                    <div class="processing-icon mb-3">
                        <i class="bi bi-cloud-upload"></i>
                    </div>
                    <h4 id="processing-title">アップロード中...</h4>
                    <p class="text-muted" id="processing-description">動画ファイルをサーバーに転送中</p>
                </div>

                <div class="processing-content">
                    <!-- アップロード進捗 -->
                    <div class="progress-container mb-4" id="upload-progress">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progress-bar"></div>
                        </div>
                        <div class="progress-text text-center">
                            <span id="progress-percentage">0%</span>
                            <span id="progress-details" class="text-muted ms-2">(0 MB / 0 MB)</span>
                        </div>
                    </div>

                    <!-- 完了後の案内 -->
                    <div class="alert alert-info" id="completion-info" style="display: none;">
                        <h6><i class="bi bi-info-circle me-2"></i>処理について</h6>
                        <p class="mb-2">動画の文字起こしとインデックス化は、バックグラウンドで自動的に実行されます。</p>
                        <p class="mb-0">処理状況は<a href="{% url 'app:video_list' %}" class="alert-link">動画一覧</a>でご確認いただけます。</p>
                    </div>

                    <div class="processing-steps">
                        <div class="step" id="step-1">
                            <div class="step-icon">
                                <i class="bi bi-upload"></i>
                            </div>
                            <div class="step-content">
                                <h6>ファイルアップロード</h6>
                                <p class="text-muted" id="step-1-desc">動画ファイルをサーバーに転送中</p>
                            </div>
                        </div>
                        <div class="step pending" id="step-2">
                            <div class="step-icon">
                                <i class="bi bi-clock"></i>
                            </div>
                            <div class="step-content">
                                <h6>処理待ち</h6>
                                <p class="text-muted">バックグラウンドで処理を開始中</p>
                            </div>
                        </div>
                        <div class="step pending" id="step-3">
                            <div class="step-icon">
                                <i class="bi bi-mic"></i>
                            </div>
                            <div class="step-content">
                                <h6>音声認識</h6>
                                <p class="text-muted">音声を文字に変換中（バックグラウンド）</p>
                            </div>
                        </div>
                        <div class="step pending" id="step-4">
                            <div class="step-icon">
                                <i class="bi bi-search"></i>
                            </div>
                            <div class="step-content">
                                <h6>検索インデックス</h6>
                                <p class="text-muted">検索用のインデックスを作成中（バックグラウンド）</p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4" id="action-buttons" style="display: none;">
                        <a href="{% url 'app:video_list' %}" class="btn btn-primary">
                            <i class="bi bi-collection-play me-2"></i>動画一覧を確認
                        </a>
                        <a href="{% url 'app:upload_video' %}" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-plus-circle me-2"></i>別の動画をアップロード
                        </a>
                    </div>
                </div>
            </div>

            <!-- 最近アップロードした動画 -->
            <div class="card recent-videos-card">
                <div class="card-header recent-videos-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>最近アップロードした動画
                    </h5>
                    <a href="{% url 'app:video_list' %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-right me-1"></i>すべて表示
                    </a>
                </div>
                <div class="card-body recent-videos-body">
                    {% if recent_videos %}
                        <div class="recent-videos-list">
                            {% for video in recent_videos %}
                                <div class="video-item d-flex align-items-center p-3 mb-3 rounded">
                                    <div class="video-icon me-3">
                                        <i class="bi bi-play-circle-fill text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <a href="{% url 'app:video_detail' video.pk %}" class="text-decoration-none">
                                                {{ video.title|truncatechars:30 }}
                                            </a>
                                        </h6>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar me-1"></i>{{ video.uploaded_at|localtime|date:"Y-m-d H:i" }}
                                        </small>
                                    </div>
                                    <div class="ms-2">
                                        {% if video.status == 'pending' %}
                                            <span class="badge bg-secondary">処理待ち</span>
                                        {% elif video.status == 'processing' %}
                                            <span class="badge bg-info">処理中</span>
                                        {% elif video.status == 'completed' %}
                                            <span class="badge bg-success">完了</span>
                                        {% elif video.status == 'error' %}
                                            <span class="badge bg-danger">エラー</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="empty-state">
                                <i class="bi bi-play-circle display-1 text-muted mb-3"></i>
                                <h6 class="mb-2">まだ動画がありません</h6>
                                <p class="text-muted">最初の動画をアップロードしましょう！</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-container {
    padding: 2rem 0;
}

.upload-header {
    margin-bottom: 3rem;
}

.upload-icon {
    width: 80px;
    height: 80px;
    background: var(--primary-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    box-shadow: var(--shadow-sm);
}

.upload-icon i {
    font-size: 2rem;
    color: white;
}

.upload-card {
    padding: 2rem;
    margin-bottom: 2rem;
}

.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--border-radius);
    padding: 3rem 2rem;
    text-align: center;
    transition: var(--transition);
    background: var(--light-color);
    margin-bottom: 2rem;
}

.upload-area.dragover {
    border-color: var(--primary-color);
    background: rgba(37, 99, 235, 0.05);
}

.upload-icon-large {
    width: 100px;
    height: 100px;
    background: var(--light-color);
    border: 2px solid var(--border-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.upload-icon-large i {
    font-size: 3rem;
    color: var(--text-muted);
}

/* アップロード完了時のアイコン */
.upload-icon-large.upload-complete {
    background: var(--success-color);
    border-color: var(--success-color);
}

.upload-icon-large.upload-complete i {
    color: white;
}

/* ファイルサイズ警告 */
#file-size-warning {
    border-left: 4px solid #ffc107;
    background: rgba(255, 193, 7, 0.1);
}

#file-size-warning .bi-exclamation-triangle {
    color: #856404;
}

/* アップロード制限情報 */
.upload-info .alert-info {
    border-left: 4px solid #17a2b8;
    background: rgba(23, 162, 184, 0.1);
}

.upload-info .alert-info .bi-info-circle {
    color: #0c5460;
}

/* 危険な状態のアップロードエリア */
.upload-area .upload-icon-large[style*="danger-gradient"] {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
}

.upload-form .form-control {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    transition: var(--transition);
    background: rgba(255, 255, 255, 0.9);
}

.upload-form .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    background: var(--background-color);
}

.upload-form .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
}

/* 処理状況 */
.processing-card {
    padding: 2rem;
    margin-bottom: 2rem;
}

.processing-icon {
    width: 80px;
    height: 80px;
    background: var(--info-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    box-shadow: var(--shadow-sm);
    animation: spin 2s linear infinite;
}

.processing-icon i {
    font-size: 2rem;
    color: white;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.progress {
    height: 12px;
    border-radius: 6px;
    background: rgba(0,0,0,0.1);
    overflow: hidden;
}

.progress-bar {
    background: var(--primary-color);
    border-radius: 6px;
}

.progress-text {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 1.1rem;
}

/* 処理ステップ */
.processing-steps {
    display: grid;
    gap: 1.5rem;
}

.step {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-radius: var(--border-radius);
    background: var(--light-color);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    opacity: 0.6;
}

.step.active {
    background: rgba(37, 99, 235, 0.05);
    border-color: var(--primary-color);
    opacity: 1;
}

.step.completed {
    background: rgba(5, 150, 105, 0.05);
    border-color: var(--success-color);
    opacity: 1;
}

.step.pending {
    background: var(--light-color);
    border-color: var(--border-color);
    opacity: 1;
}

.step-icon {
    width: 50px;
    height: 50px;
    background: var(--light-color);
    border: 1px solid var(--border-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
}

.step.active .step-icon {
    background: var(--primary-color);
    border-color: var(--primary-color);
}

.step.completed .step-icon {
    background: var(--success-color);
    border-color: var(--success-color);
}

.step.pending .step-icon {
    background: var(--light-color);
    border-color: var(--border-color);
}

.step-icon i {
    font-size: 1.25rem;
    color: var(--text-muted);
}

.step.active .step-icon i,
.step.completed .step-icon i {
    color: white;
}

.step.pending .step-icon i {
    color: var(--text-muted);
}

.step-content h6 {
    margin-bottom: 0.25rem;
    font-weight: 600;
}

.step-content p {
    margin-bottom: 0;
    font-size: 0.9rem;
}

/* 最近の動画 */
.recent-videos-card {
    margin-bottom: 2rem;
}

.recent-videos-list {
    margin: 0;
    padding: 0;
}

.video-item {
    background: var(--background-color);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    border-radius: var(--border-radius);
}

.video-item:hover {
    background: var(--background-secondary);
    border-color: var(--primary-color);
}

.video-icon i {
    font-size: 1.5rem;
}

.empty-state {
    padding: 2rem 1rem;
}

.empty-state .display-1 {
    opacity: 0.5;
}

/* レスポンシブ */
@media (max-width: 768px) {
    .upload-card,
    .processing-card {
        padding: 1.5rem;
    }
    
    .upload-area {
        padding: 2rem 1rem;
    }
    
    .upload-icon-large {
        width: 80px;
        height: 80px;
    }
    
    .upload-icon-large i {
        font-size: 2.5rem;
    }
}
</style>

<script>
  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('id_file');
  const uploadBtn = document.getElementById('upload-btn');

  document.addEventListener('DOMContentLoaded', function() {
    // ファイル選択時の処理
    fileInput.addEventListener('change', handleFileSelect);
  });

  // ドラッグ&ドロップイベント
  uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
          fileInput.files = files;
          handleFileSelect();
      }
  });

  // API設定状態をグローバル変数として定義（テンプレート出力を安全に文字列で受け取りJSON.parseで真偽値化）
  const apiKeyConfigured = JSON.parse("{{ api_key_configured|yesno:'true,false' }}");

  function handleFileSelect() {
      const file = fileInput.files[0];
      const fileSizeWarning = document.getElementById('file-size-warning');
      const uploadBtn = document.getElementById('upload-btn');
      // サーバ側の上限（残り本数）が0ならボタンを無効化
      const remaining = parseInt("{{ user_video_remaining|default:'0' }}");
      if (!isNaN(remaining) && remaining <= 0) {
          uploadBtn.disabled = true;
          uploadBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>動画上限に達しています';
      }
      
      if (file) {
          const fileSizeMB = file.size / 1024 / 1024;
          const maxSizeMB = parseInt('{{ video_upload_max_size_mb }}');
          
          // ファイルサイズチェック
          if (fileSizeMB > maxSizeMB) {
              // 警告を表示
              fileSizeWarning.style.display = 'block';
              uploadBtn.disabled = true;
              uploadBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>ファイルサイズが上限を超えています';
              
              uploadArea.innerHTML = `
                  <div class="upload-content text-center">
                      <div class="upload-icon-large mb-4" style="background: var(--danger-gradient);">
                          <i class="bi bi-exclamation-triangle" style="color: white;"></i>
                      </div>
                      <h4 class="mb-3 text-danger">${file.name}</h4>
                      <p class="text-danger mb-4">ファイルサイズ: ${fileSizeMB.toFixed(2)} MB (上限: ${maxSizeMB} MB)</p>
                      <button type="button" class="btn btn-outline-danger" onclick="document.getElementById('id_file').click()">
                          <i class="bi bi-arrow-clockwise me-2"></i>別のファイルを選択
                      </button>
                  </div>
              `;
          } else {
              // 正常なファイル
              fileSizeWarning.style.display = 'none';
              // API設定チェック
              if (apiKeyConfigured) {
                  uploadBtn.disabled = false;
                  uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>動画をアップロード';
              } else {
                  uploadBtn.disabled = true;
                  uploadBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>API設定が必要です';
              }
              
              uploadArea.innerHTML = `
                  <div class="upload-content text-center">
                      <div class="upload-icon-large mb-4 upload-complete">
                          <i class="bi bi-check-circle"></i>
                      </div>
                      <h4 class="mb-3 text-success">${file.name}</h4>
                      <p class="text-success mb-4">ファイルサイズ: ${fileSizeMB.toFixed(2)} MB</p>
                      <button type="button" class="btn btn-outline-success" onclick="document.getElementById('id_file').click()">
                          <i class="bi bi-arrow-clockwise me-2"></i>別のファイルを選択
                      </button>
                  </div>
              `;
          }
      } else {
          // ファイルが選択されていない場合
          fileSizeWarning.style.display = 'none';
          uploadBtn.disabled = true;
          uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>動画をアップロード';
          
          // 元のアップロードエリアを復元
          uploadArea.innerHTML = `
              <div class="upload-content text-center">
                  <div class="upload-icon-large mb-4">
                      <i class="bi bi-cloud-upload"></i>
                  </div>
                  <h4 class="mb-3">動画ファイルをドラッグ&ドロップ</h4>
                  <p class="text-muted mb-4">または、下のボタンからファイルを選択してください</p>
                  <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('id_file').click()">
                      <i class="bi bi-folder2-open me-2"></i>ファイルを選択
                  </button>
                  <div class="upload-info mt-4">
                      <div class="alert alert-info mb-3">
                          <i class="bi bi-info-circle me-2"></i>
                          <strong>アップロード制限</strong><br>
                          対応形式: MP4, AVI, MOV, MKV<br>
                          <span class="text-primary fw-bold">※最大アップロードサイズは {{ video_upload_max_size_mb }}MB です</span>
                      </div>
                      <div class="alert alert-warning" id="file-size-warning" style="display: none;">
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          <strong>ファイルサイズが上限を超えています</strong><br>
                          選択されたファイルは{{ video_upload_max_size_mb }}MBを超えています。より小さなファイルを選択してください。
                      </div>
                  </div>
              </div>
          `;
      }
  }

  // アップロードフォームの処理
  document.getElementById('upload-form').addEventListener('submit', function(e) {
      e.preventDefault(); // デフォルトの送信を防止
      const form = this;
      const processingStatus = document.getElementById('processing-status');
      const progressBar = document.getElementById('progress-bar');
      const progressPercentage = document.getElementById('progress-percentage');
      const progressDetails = document.getElementById('progress-details');
      const processingTitle = document.getElementById('processing-title');
      const processingDescription = document.getElementById('processing-description');
      const step1Desc = document.getElementById('step-1-desc');
      const completionInfo = document.getElementById('completion-info');
      const actionButtons = document.getElementById('action-buttons');
      // ファイルサイズを取得
      const file = fileInput.files[0];
      if (!file) {
          alert('ファイルを選択してください');
          return;
      }
      
      // ファイルサイズの最終チェック
      const fileSize = file.size;
      const fileSizeMB = fileSize / 1024 / 1024;
      const maxSizeMB = parseInt('{{ video_upload_max_size_mb }}');
      
      if (fileSizeMB > maxSizeMB) {
          alert(`ファイルサイズが上限を超えています。\n選択されたファイル: ${fileSizeMB.toFixed(2)} MB\n上限: ${maxSizeMB} MB\n\nより小さなファイルを選択してください。`);
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>動画をアップロード';
          return;
      }
      // ボタンを無効化
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>アップロード中...';
      // 処理状況を表示
      processingStatus.style.display = 'block';
      processingStatus.scrollIntoView({ behavior: 'smooth' });
      // ステップ1をアクティブに
      document.getElementById('step-1').classList.add('active');
      // FormDataを作成
      const formData = new FormData(form);
      // XMLHttpRequestでアップロード
      const xhr = new XMLHttpRequest();
      // 進捗イベント
      xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
              const percentComplete = (e.loaded / e.total) * 100;
              const loadedMB = (e.loaded / 1024 / 1024).toFixed(2);
              progressBar.style.width = percentComplete + '%';
              progressPercentage.textContent = Math.round(percentComplete) + '%';
              progressDetails.textContent = `(${loadedMB} MB / ${fileSizeMB.toFixed(2)} MB)`;
              // 進捗に応じてステップ1の説明を更新
              if (percentComplete >= 100) {
                  step1Desc.textContent = '動画ファイルをサーバーに転送完了';
                  document.getElementById('step-1').classList.remove('active');
                  document.getElementById('step-1').classList.add('completed');
              }
          }
      });
      // 完了イベント
      xhr.addEventListener('load', function() {
          let payload = {};
          try { payload = JSON.parse(xhr.responseText || '{}'); } catch (e) {}
          if (xhr.status === 200 && payload.success) {
              // アップロード完了
              processingTitle.textContent = 'アップロード完了';
              processingDescription.textContent = '動画ファイルのアップロードが完了しました';
              document.getElementById('upload-progress').style.display = 'none';
              completionInfo.style.display = 'block';
              actionButtons.style.display = 'block';
              document.getElementById('step-2').classList.remove('pending');
              document.getElementById('step-2').classList.add('active');
              setTimeout(() => {
                  alert('動画のアップロードが完了しました！\n文字起こしとインデックス化はバックグラウンドで実行されます。');
              }, 500);
          } else {
              // エラー処理（上限超過など）
              const message = (payload && payload.error) ? payload.error : 'アップロード中にエラーが発生しました。もう一度お試しください。';
              alert(message);
              uploadBtn.disabled = false;
              uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>アップロード';
              processingStatus.style.display = 'none';
          }
      });
      // エラーイベント
      xhr.addEventListener('error', function() {
          alert('アップロード中にエラーが発生しました。もう一度お試しください。');
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>アップロード';
          processingStatus.style.display = 'none';
      });
      // リクエストを送信
      xhr.open('POST', form.action);
      // CSRFトークンを取得
      const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
      xhr.setRequestHeader('X-CSRFToken', csrfToken);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      xhr.send(formData);
  });
</script>
{% endblock %} 