{% extends 'app/base.html' %}
{% load tz %}

{% block title %}Video Upload - VideoQ{% endblock %}

{% block content %}


<div class="upload-container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="upload-header text-center mb-5">
                <div class="upload-icon mb-3">
                    <i class="bi bi-cloud-upload"></i>
                </div>
                <h1 class="page-title mb-3">Upload Video</h1>
                <p class="lead text-muted">Maximize your video content with AI-powered video analysis</p>
            </div>

            <!-- Upload Form -->
            <div class="card upload-card">
                {% if user_video_remaining|default:0 <= 0 %}
                <div class="alert alert-warning m-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Video limit ({{ user_video_limit }} videos) has been reached. Please delete unnecessary videos.
                    <a href="{% url 'app:video_list' %}" class="alert-link ms-2">Go to Video List</a>
                </div>
                {% elif over_limit %}
                <div class="alert alert-info m-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Currently {{ user_video_count }} videos (limit: {{ user_video_limit }} videos).
                    When you upload a new video, older videos will be automatically hidden.
                </div>
                {% endif %}
                <div class="upload-area" id="upload-area" {% if user_video_remaining|default:0 <= 0 %}style="pointer-events: none; opacity: .6;"{% endif %}>
                    <div class="upload-content text-center">
                        <div class="upload-icon-large mb-4">
                            <i class="bi bi-cloud-upload"></i>
                        </div>
                        <h4 class="mb-3">Drag & Drop Video File</h4>
                        <p class="text-muted mb-4">Or select a file using the button below</p>
                        {% if user_video_remaining|default:0 <= 0 %}
                        <button type="button" class="btn btn-primary btn-lg" disabled title="Video limit reached">
                            <i class="bi bi-folder2-open me-2"></i>Select File
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('id_file').click()">
                            <i class="bi bi-folder2-open me-2"></i>Select File
                        </button>
                        {% endif %}
                        <div class="upload-info mt-4">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Upload Restrictions</strong><br>
                                Supported formats: MP4, AVI, MOV, MKV<br>
                                <span class="text-primary fw-bold">â€»Maximum upload size is {{ video_upload_max_size_mb }}MB</span>
                                <div class="mt-2 small text-muted">
                                    Current videos: <strong>{{ user_video_count }}</strong> / Limit: <strong>{{ user_video_limit }}</strong> (Remaining: <strong>{{ user_video_remaining }}</strong> videos)
                                </div>
                            </div>
                            <div class="alert alert-warning" id="file-size-warning" style="display: none;">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>File size exceeds limit</strong><br>
                                Selected file exceeds {{ video_upload_max_size_mb }}MB. Please select a smaller file.
                            </div>
                        </div>
                    </div>
                </div>

                <form method="post" enctype="multipart/form-data" id="upload-form" class="upload-form">
                    {% csrf_token %}
                    
                    <div class="form-group mb-4">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            <i class="bi bi-tag me-2"></i>Video Title
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.title.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group mb-4">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            <i class="bi bi-text-paragraph me-2"></i>Description (Optional)
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Existing Tag Selection -->
                    <div class="form-group mb-4">
                        <label class="form-label">
                            <i class="bi bi-hash me-2"></i>Select from Existing Tags
                        </label>
                        <div class="tag-selection-container">
                            {% if existing_tags %}
                                <div class="existing-tags-grid">
                                    {% for tag in existing_tags %}
                                        <div class="tag-checkbox-item">
                                            <input type="checkbox" name="existing_tags" value="{{ tag.id }}" id="tag_{{ tag.id }}" class="tag-checkbox">
                                            <label for="tag_{{ tag.id }}" class="tag-label">
                                                <span class="tag-name">{{ tag.name }}</span>
                                                {% if tag.color %}
                                                    <span class="tag-color" style="background-color: {{ tag.color }};"></span>
                                                {% endif %}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-muted">
                                    <i class="bi bi-info-circle me-2"></i>No tags created yet. You can create new tags in the input field below.
                                </div>
                            {% endif %}
                        </div>

                    </div>

                    <!-- New Tag Input -->
                    <div class="form-group mb-4">
                        <label for="{{ form.new_tags_input.id_for_label }}" class="form-label">
                            <i class="bi bi-plus-circle me-2"></i>Add New Tags
                        </label>
                        {{ form.new_tags_input }}
                        {% if form.new_tags_input.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.new_tags_input.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Enter new tags separated by commas. Can be combined with existing tags.</div>
                    </div>

                    <div class="form-group mb-4" style="display: none;">
                        {{ form.file }}
                        {% if form.file.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.file.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- API Configuration Check Warning -->
                    {% if not api_key_configured %}
                    <div class="alert alert-warning mb-4" id="api-key-warning">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle me-3 mt-1"></i>
                            <div>
                                <h6 class="alert-heading mb-2">API Configuration Not Complete</h6>
                                <p class="mb-2">To use AI video analysis features, you need to configure your OpenAI API key.</p>
                                <a href="{% url 'app:openai_key_update' %}" class="btn btn-warning btn-sm">
                                    <i class="bi bi-key me-2"></i>Configure API
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="upload-btn" {% if user_video_remaining|default:0 <= 0 %}disabled title="Video limit reached"{% else %}disabled {% if not api_key_configured %}title="Please complete API configuration"{% endif %}{% endif %}>
                            <i class="bi bi-upload me-2"></i>Upload Video
                        </button>
                    </div>
                </form>
            </div>

            <!-- Processing Status Display Area -->
            <div class="card processing-card" id="processing-status" style="display: none;">
                <div class="processing-header text-center mb-4">
                    <div class="processing-icon mb-3">
                        <i class="bi bi-cloud-upload"></i>
                    </div>
                    <h4 id="processing-title">Uploading...</h4>
                    <p class="text-muted" id="processing-description">Transferring video file to server</p>
                </div>

                <div class="processing-content">
                    <!-- Upload Progress -->
                    <div class="progress-container mb-4" id="upload-progress">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progress-bar"></div>
                        </div>
                        <div class="progress-text text-center">
                            <span id="progress-percentage">0%</span>
                            <span id="progress-details" class="text-muted ms-2">(0 MB / 0 MB)</span>
                        </div>
                    </div>

                    <!-- Completion Guide -->
                    <div class="alert alert-info" id="completion-info" style="display: none;">
                        <h6><i class="bi bi-info-circle me-2"></i>About Processing</h6>
                        <p class="mb-2">Video transcription and indexing will be automatically executed in the background.</p>
                        <p class="mb-0">You can check the processing status in the <a href="{% url 'app:video_list' %}" class="alert-link">Video List</a>.</p>
                    </div>

                    <div class="processing-steps">
                        <div class="step" id="step-1">
                            <div class="step-icon">
                                <i class="bi bi-upload"></i>
                            </div>
                            <div class="step-content">
                                <h6>File Upload</h6>
                                <p class="text-muted" id="step-1-desc">Transferring video file to server</p>
                            </div>
                        </div>
                        <div class="step pending" id="step-2">
                            <div class="step-icon">
                                <i class="bi bi-clock"></i>
                            </div>
                            <div class="step-content">
                                <h6>Pending</h6>
                                <p class="text-muted">Starting background processing</p>
                            </div>
                        </div>
                        <div class="step pending" id="step-3">
                            <div class="step-icon">
                                <i class="bi bi-mic"></i>
                            </div>
                            <div class="step-content">
                                <h6>Speech Recognition</h6>
                                <p class="text-muted">Converting audio to text (background)</p>
                            </div>
                        </div>
                        <div class="step pending" id="step-4">
                            <div class="step-icon">
                                <i class="bi bi-search"></i>
                            </div>
                            <div class="step-content">
                                <h6>Search Index</h6>
                                <p class="text-muted">Creating search index (background)</p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4" id="action-buttons" style="display: none;">
                        <a href="{% url 'app:video_list' %}" class="btn btn-primary">
                            <i class="bi bi-collection-play me-2"></i>Check Video List
                        </a>
                        <a href="{% url 'app:upload_video' %}" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-plus-circle me-2"></i>Upload Another Video
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recently Uploaded Videos -->
            <div class="card recent-videos-card">
                <div class="card-header recent-videos-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>Recently Uploaded Videos
                    </h5>
                    <a href="{% url 'app:video_list' %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-right me-1"></i>View All
                    </a>
                </div>
                <div class="card-body recent-videos-body">
                    {% if recent_videos %}
                        <div class="recent-videos-list">
                            {% for video in recent_videos %}
                                <div class="video-item d-flex align-items-center p-3 mb-3 rounded">
                                    <div class="video-icon me-3">
                                        <i class="bi bi-play-circle-fill text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <a href="{% url 'app:video_detail' video.pk %}" class="text-decoration-none">
                                                {{ video.title|truncatechars:30 }}
                                            </a>
                                        </h6>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar me-1"></i>{{ video.uploaded_at|date:"Y-m-d H:i" }}
                                        </small>
                                    </div>
                                    <div class="ms-2">
                                        {% if video.status == 'pending' %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% elif video.status == 'processing' %}
                                            <span class="badge bg-info">Processing</span>
                                        {% elif video.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif video.status == 'error' %}
                                            <span class="badge bg-danger">Error</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="empty-state">
                                <i class="bi bi-play-circle display-1 text-muted mb-3"></i>
                                <h6 class="mb-2">No videos yet</h6>
                                <p class="text-muted">Let's upload your first video!</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-container {
    padding: 2rem 0;
}

.upload-header {
    margin-bottom: 3rem;
}

.upload-icon {
    width: 80px;
    height: 80px;
    background: var(--primary-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    box-shadow: var(--shadow-sm);
}

.upload-icon i {
    font-size: 2rem;
    color: white;
}

.upload-card {
    padding: 2rem;
    margin-bottom: 2rem;
}

.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--border-radius);
    padding: 3rem 2rem;
    text-align: center;
    transition: var(--transition);
    background: var(--light-color);
    margin-bottom: 2rem;
}

.upload-area.dragover {
    border-color: var(--primary-color);
    background: rgba(37, 99, 235, 0.05);
}

.upload-icon-large {
    width: 100px;
    height: 100px;
    background: var(--light-color);
    border: 2px solid var(--border-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.upload-icon-large i {
    font-size: 3rem;
    color: var(--text-muted);
}

/* Upload completion icon */
.upload-icon-large.upload-complete {
    background: var(--success-color);
    border-color: var(--success-color);
}

.upload-icon-large.upload-complete i {
    color: white;
}

/* File size warning */
#file-size-warning {
    border-left: 4px solid #ffc107;
    background: rgba(255, 193, 7, 0.1);
}

#file-size-warning .bi-exclamation-triangle {
    color: #856404;
}

/* Upload restriction information */
.upload-info .alert-info {
    border-left: 4px solid #17a2b8;
    background: rgba(23, 162, 184, 0.1);
}

.upload-info .alert-info .bi-info-circle {
    color: #0c5460;
}

/* Dangerous state upload area */
.upload-area .upload-icon-large[style*="danger-gradient"] {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
}

.upload-form .form-control {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    transition: var(--transition);
    background: rgba(255, 255, 255, 0.9);
}

.upload-form .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    background: var(--background-color);
}

.upload-form .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
}

/* Processing status */
.processing-card {
    padding: 2rem;
    margin-bottom: 2rem;
}

.processing-icon {
    width: 80px;
    height: 80px;
    background: var(--info-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    box-shadow: var(--shadow-sm);
    animation: spin 2s linear infinite;
}

.processing-icon i {
    font-size: 2rem;
    color: white;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.progress {
    height: 12px;
    border-radius: 6px;
    background: rgba(0,0,0,0.1);
    overflow: hidden;
}

.progress-bar {
    background: var(--primary-color);
    border-radius: 6px;
}

.progress-text {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 1.1rem;
}

/* Processing steps */
.processing-steps {
    display: grid;
    gap: 1.5rem;
}

.step {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-radius: var(--border-radius);
    background: var(--light-color);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    opacity: 0.6;
}

.step.active {
    background: rgba(37, 99, 235, 0.05);
    border-color: var(--primary-color);
    opacity: 1;
}

.step.completed {
    background: rgba(5, 150, 105, 0.05);
    border-color: var(--success-color);
    opacity: 1;
}

.step.pending {
    background: var(--light-color);
    border-color: var(--border-color);
    opacity: 1;
}

.step-icon {
    width: 50px;
    height: 50px;
    background: var(--light-color);
    border: 1px solid var(--border-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
}

.step.active .step-icon {
    background: var(--primary-color);
    border-color: var(--primary-color);
}

.step.completed .step-icon {
    background: var(--success-color);
    border-color: var(--success-color);
}

.step.pending .step-icon {
    background: var(--light-color);
    border-color: var(--border-color);
}

.step-icon i {
    font-size: 1.25rem;
    color: var(--text-muted);
}

.step.active .step-icon i,
.step.completed .step-icon i {
    color: white;
}

.step.pending .step-icon i {
    color: var(--text-muted);
}

.step-content h6 {
    margin-bottom: 0.25rem;
    font-weight: 600;
}

.step-content p {
    margin-bottom: 0;
    font-size: 0.9rem;
}

/* Recent videos */
.recent-videos-card {
    margin-bottom: 2rem;
}

.recent-videos-list {
    margin: 0;
    padding: 0;
}

.video-item {
    background: var(--background-color);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    border-radius: var(--border-radius);
}

.video-item:hover {
    background: var(--background-secondary);
    border-color: var(--primary-color);
}

.video-icon i {
    font-size: 1.5rem;
}

.empty-state {
    padding: 2rem 1rem;
}

.empty-state .display-1 {
    opacity: 0.5;
}

/* Responsive */
@media (max-width: 768px) {
    .upload-card,
    .processing-card {
        padding: 1.5rem;
    }
    
    .upload-area {
        padding: 2rem 1rem;
    }
    
    .upload-icon-large {
        width: 80px;
        height: 80px;
    }
    
    .upload-icon-large i {
        font-size: 2.5rem;
    }
}
</style>

<script>
  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('id_file');
  const uploadBtn = document.getElementById('upload-btn');

  document.addEventListener('DOMContentLoaded', function() {
    // Handle file selection
    fileInput.addEventListener('change', handleFileSelect);
  });

  // Drag & Drop events
  uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
          fileInput.files = files;
          handleFileSelect();
      }
  });

  // Define API configuration state as global variable (safely receive template output as string and convert to boolean with JSON.parse)
  const apiKeyConfigured = JSON.parse("{{ api_key_configured|yesno:'true,false' }}");

  function handleFileSelect() {
      const file = fileInput.files[0];
      const fileSizeWarning = document.getElementById('file-size-warning');
      const uploadBtn = document.getElementById('upload-btn');
      // Disable button if server-side limit (remaining count) is 0
      const remaining = parseInt("{{ user_video_remaining|default:'0' }}");
      if (!isNaN(remaining) && remaining <= 0) {
          uploadBtn.disabled = true;
          uploadBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Video limit reached';
      }
      
      if (file) {
          const fileSizeMB = file.size / 1024 / 1024;
          const maxSizeMB = parseInt('{{ video_upload_max_size_mb }}');
          
          // File size check
          if (fileSizeMB > maxSizeMB) {
              // Show warning
              fileSizeWarning.style.display = 'block';
              uploadBtn.disabled = true;
              uploadBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>File size exceeds limit';
              
              uploadArea.innerHTML = `
                  <div class="upload-content text-center">
                      <div class="upload-icon-large mb-4" style="background: var(--danger-gradient);">
                          <i class="bi bi-exclamation-triangle" style="color: white;"></i>
                      </div>
                      <h4 class="mb-3 text-danger">${file.name}</h4>
                      <p class="text-danger mb-4">File size: ${fileSizeMB.toFixed(2)} MB (Limit: ${maxSizeMB} MB)</p>
                      <button type="button" class="btn btn-outline-danger" onclick="document.getElementById('id_file').click()">
                          <i class="bi bi-arrow-clockwise me-2"></i>Select Different File
                      </button>
                  </div>
              `;
          } else {
              // Valid file
              fileSizeWarning.style.display = 'none';
              // API configuration check
              if (apiKeyConfigured) {
                  uploadBtn.disabled = false;
                  uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Upload Video';
              } else {
                  uploadBtn.disabled = true;
                  uploadBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>API configuration required';
              }
              
              uploadArea.innerHTML = `
                  <div class="upload-content text-center">
                      <div class="upload-icon-large mb-4 upload-complete">
                          <i class="bi bi-check-circle"></i>
                      </div>
                      <h4 class="mb-3 text-success">${file.name}</h4>
                      <p class="text-success mb-4">File size: ${fileSizeMB.toFixed(2)} MB</p>
                      <button type="button" class="btn btn-outline-success" onclick="document.getElementById('id_file').click()">
                          <i class="bi bi-arrow-clockwise me-2"></i>Select Different File
                      </button>
                  </div>
              `;
          }
      } else {
          // When no file is selected
          fileSizeWarning.style.display = 'none';
          uploadBtn.disabled = true;
          uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Upload Video';
          
          // Restore original upload area
          uploadArea.innerHTML = `
              <div class="upload-content text-center">
                  <div class="upload-icon-large mb-4">
                      <i class="bi bi-cloud-upload"></i>
                  </div>
                  <h4 class="mb-3">Drag & Drop Video File</h4>
                  <p class="text-muted mb-4">Or select a file using the button below</p>
                  <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('id_file').click()">
                      <i class="bi bi-folder2-open me-2"></i>Select File
                  </button>
                  <div class="upload-info mt-4">
                      <div class="alert alert-info mb-3">
                          <i class="bi bi-info-circle me-2"></i>
                          <strong>Upload Restrictions</strong><br>
                          Supported formats: MP4, AVI, MOV, MKV<br>
                          <span class="text-primary fw-bold">â€»Maximum upload size is {{ video_upload_max_size_mb }}MB</span>
                      </div>
                      <div class="alert alert-warning" id="file-size-warning" style="display: none;">
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          <strong>File size exceeds limit</strong><br>
                          Selected file exceeds {{ video_upload_max_size_mb }}MB. Please select a smaller file.
                      </div>
                  </div>
              </div>
          `;
      }
  }

  // Handle upload form
  document.getElementById('upload-form').addEventListener('submit', function(e) {
      e.preventDefault(); // Prevent default submission
      const form = this;
      const processingStatus = document.getElementById('processing-status');
      const progressBar = document.getElementById('progress-bar');
      const progressPercentage = document.getElementById('progress-percentage');
      const progressDetails = document.getElementById('progress-details');
      const processingTitle = document.getElementById('processing-title');
      const processingDescription = document.getElementById('processing-description');
      const step1Desc = document.getElementById('step-1-desc');
      const completionInfo = document.getElementById('completion-info');
      const actionButtons = document.getElementById('action-buttons');
      // Get file size
      const file = fileInput.files[0];
      if (!file) {
          alert('Please select a file');
          return;
      }
      
      // Final file size check
      const fileSize = file.size;
      const fileSizeMB = fileSize / 1024 / 1024;
      const maxSizeMB = parseInt('{{ video_upload_max_size_mb }}');
      
      if (fileSizeMB > maxSizeMB) {
          alert(`File size exceeds limit.\nSelected file: ${fileSizeMB.toFixed(2)} MB\nLimit: ${maxSizeMB} MB\n\nPlease select a smaller file.`);
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Upload Video';
          return;
      }
      // Disable button
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Uploading...';
      // Show processing status
      processingStatus.style.display = 'block';
      processingStatus.scrollIntoView({ behavior: 'smooth' });
      // Activate step 1
      document.getElementById('step-1').classList.add('active');
      // Create FormData
      const formData = new FormData(form);
      // Upload with XMLHttpRequest
      const xhr = new XMLHttpRequest();
      // Progress event
      xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
              const percentComplete = (e.loaded / e.total) * 100;
              const loadedMB = (e.loaded / 1024 / 1024).toFixed(2);
              progressBar.style.width = percentComplete + '%';
              progressPercentage.textContent = Math.round(percentComplete) + '%';
              progressDetails.textContent = `(${loadedMB} MB / ${fileSizeMB.toFixed(2)} MB)`;
              // Update step 1 description based on progress
              if (percentComplete >= 100) {
                  step1Desc.textContent = 'Video file transfer to server completed';
                  document.getElementById('step-1').classList.remove('active');
                  document.getElementById('step-1').classList.add('completed');
              }
          }
      });
      // Completion event
      xhr.addEventListener('load', function() {
          let payload = {};
          try { payload = JSON.parse(xhr.responseText || '{}'); } catch (e) {}
          if (xhr.status === 200 && payload.success) {
              // Upload completed
              processingTitle.textContent = 'Upload Completed';
              processingDescription.textContent = 'Video file upload has been completed';
              document.getElementById('upload-progress').style.display = 'none';
              completionInfo.style.display = 'block';
              actionButtons.style.display = 'block';
              document.getElementById('step-2').classList.remove('pending');
              document.getElementById('step-2').classList.add('active');
              setTimeout(() => {
                  alert('Video upload completed!\nTranscription and indexing will be executed in the background.');
              }, 500);
          } else {
              // Error handling (limit exceeded, etc.)
              const message = (payload && payload.error) ? payload.error : 'An error occurred during upload. Please try again.';
              alert(message);
              uploadBtn.disabled = false;
              uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Upload';
              processingStatus.style.display = 'none';
          }
      });
      // Error event
      xhr.addEventListener('error', function() {
          alert('An error occurred during upload. Please try again.');
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Upload';
          processingStatus.style.display = 'none';
      });
      // Send request
      xhr.open('POST', form.action);
      // Get CSRF token
      const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
      xhr.setRequestHeader('X-CSRFToken', csrfToken);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      xhr.send(formData);
  });
</script>
{% endblock %} 