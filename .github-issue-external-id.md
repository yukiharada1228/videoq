# 外部LMS連携のためVideoモデルに外部システムID追跡フィールドを追加

## 背景

既存のLMS（Learning Management System）とVideoQバックエンドを連携する場合、既存LMSの動画には既にID（例: MoodleのContent Module ID、CanvasのContent IDなど）が付与されています。

現状のVideoモデルでは、これらの外部IDを保存・追跡する仕組みがないため、外部システムとの適切な連携ができません。

## 現状の問題点

**Videoモデルの現状** (`backend/app/models.py:109-149`):
- `id`: 自動採番のBigAutoField（VideoQ内部の主キー）
- `is_external_upload`: Boolean（処理後の削除フラグ、外部IDとは無関係）
- **外部システムIDを保存するフィールドが存在しない**

**この問題による影響**:
1. **双方向参照が不可能**: 既存LMS → VideoQの紐付けができない
2. **重複チェックができない**: 同じ動画が複数回アップロードされる可能性
3. **同期が困難**: 既存LMSでの更新をVideoQに反映できない
4. **既存データとの整合性**: 既存LMSのコンテンツ構造を維持できない

## 提案する解決策

Videoモデルに`external_id`フィールドを追加する：

### `external_id` (CharField)
- 外部LMSの動画ID（例: Moodleの`cm_id`、Canvasの`content_id`）
- nullable, blank=True, unique=True
- 外部システムからのインポート時に設定
- 同じ動画が重複してインポートされるのを防ぐ
- 追加の情報が必要な場合は外部LMSのAPIで取得可能

## 実装例

```python
class Video(models.Model):
    # 既存フィールド...

    # 外部LMS連携用フィールド
    external_id = models.CharField(
        max_length=255,
        null=True,
        blank=True,
        unique=True,
        help_text="ID from external LMS (e.g., Moodle cm_id, Canvas content_id)"
    )
```

## 実装タスク

### データモデル
- [ ] Videoモデルに`external_id`フィールドを追加 (`backend/app/models.py`)
- [ ] マイグレーションファイルを作成

### API更新
- [ ] VideoSerializer/VideoCreateSerializerを更新（`external_id`をサポート） (`backend/app/video/serializers.py`)
- [ ] API仕様を更新（OpenAPI schema）
- [ ] 外部IDによる検索・取得機能を追加（オプション）
  - クエリパラメータ: `GET /api/videos/?external_id=12345`
  - または専用エンドポイント: `GET /api/videos/by-external-id/<external_id>/`

### チャット/RAG機能でのexternal_id対応
- [ ] ベクトルインデックス作成時にmetadataに`external_id`を含める (`backend/app/tasks/vector_indexing.py`)
  - ドキュメントメタデータに `"external_id": video.external_id` を追加
- [ ] RAG抽出時に`external_id`を取得して返す (`backend/app/chat/services/rag_chat.py`)
  - `_extract_related_videos`メソッドで`external_id`をメタデータから取得
  - `related_videos`レスポンスに含める
- [ ] 既存のベクトルデータの再インデックス（external_id追加後）
  - 既存動画のベクトルデータにexternal_idが含まれていないため、再作成が必要

### ドキュメント
- [ ] ドキュメント更新

## 期待される効果

- 既存LMSとVideoQの動画を確実に紐付けられる
- 既存LMSからVideoQへの参照が可能になる
- 動画の重複インポートを防止できる
- 既存LMSとVideoQの双方向同期の基盤となる
- **チャット機能のレスポンスに`external_id`が含まれるため、外部LMSへのディープリンクが可能になる**
  - 例: チャット結果から直接、元のLMSの該当コンテンツページへリンク
  - `related_videos[].external_id`を使って外部システムのURLを構築可能

## 関連情報

- Videoモデル: `backend/app/models.py:109-149`
- Serializers: `backend/app/video/serializers.py`
- Views: `backend/app/video/views.py`
