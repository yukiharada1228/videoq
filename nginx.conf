events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    client_max_body_size 1000M;

    # Rate limit zones
    limit_req_zone $binary_remote_addr zone=chat_zone:10m rate=20r/m;
    limit_req_zone $binary_remote_addr zone=auth_zone:10m rate=5r/m;

    upstream backend {
        server videoq-backend:8000;
    }

    upstream frontend {
        server videoq-frontend:80;
    }

    server {
        listen 80;
        server_name _;

        # Static files served directly by nginx
        location /api/static/ {
            alias /static/;
        }

        # Protected media files (internal use only)
        location /api/protected_media/ {
            internal;
            alias /media/;
        }

        # Chat endpoint - strict rate limit (LLM API cost protection)
        location /api/chat/ {
            limit_req zone=chat_zone burst=5 nodelay;
            limit_req_status 429;

            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth login/password-reset - rate limit to prevent brute force
        # Only targets POST-heavy attack surfaces, not /me or /refresh
        location /api/auth/login/ {
            limit_req zone=auth_zone burst=3 nodelay;
            limit_req_status 429;

            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/auth/password-reset/ {
            limit_req zone=auth_zone burst=3 nodelay;
            limit_req_status 429;

            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # All API routes to backend (admin, media, auth, etc.)
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # All other routes to frontend
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support (upgrade headers)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
